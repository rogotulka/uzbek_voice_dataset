
import time
import csv
from selenium import webdriver
from selenium.webdriver.common.by import By
from webdriver_manager.chrome import ChromeDriverManager
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver import ActionChains

# Настройка Chrome Driver
chrome_options = Options()
#chrome_options.add_argument("--headless")  # Для запуска в фоновом режиме, без GUI
chrome_options.add_argument("--no-sandbox")
chrome_options.add_argument("--disable-dev-shm-usage")

# Инициализация WebDriver
driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=chrome_options)

try:
    # Переход на указанный сайт
    driver.get("https://sharh.commeta.uz/ru/click")

    # Небольшая пауза для загрузки страницы (может потребоваться больше времени в зависимости от скорости интернета и сервера)
    time.sleep(5)

    # Set to store unique data
    unique_data = set()

    while True:
        time.sleep(5)

        # Скроллинг страницы
        driver.execute_script("window.scrollTo(0, 5000)")

        time.sleep(5)

        # Получение отзывов и никнеймов
        reviews = driver.find_elements(By.XPATH, "//div[@data-v-792071f1]/span[@data-v-792071f1]")
        nicknames = driver.find_elements(By.XPATH, "//h3[@class='text-base font-semibold leading-130 text-blue-800 duration-300 line-clamp-1 hover:text-blue']")

        # Сохранение уникальных данных в списки
        for review, nickname in zip(reviews, nicknames):
            review_text = review.text
            nickname_text = nickname.text
            if (nickname_text, review_text) not in unique_data:
                unique_data.add((nickname_text, review_text))

        # Сохранение данных в файле CSV
        with open('reviews.csv', mode='w', newline='', encoding='utf-8') as file:
            writer = csv.writer(file, delimiter=',')
            writer.writerow(['Nickname', 'Review'])  # Writing column headers
            for nickname_text, review_text in unique_data:
                writer.writerow([nickname_text, review_text])

        # Проверка наличия кнопки "Yana yuklash" для загрузки дополнительных данных
        elements = driver.find_elements(By.XPATH, "//span[contains(text(), 'Yana yuklash') or contains(text(), 'Загрузить еще') or contains(text(), 'Load more')]")
        if not elements:
            break

        # Клик по кнопке "Загрузить ещё"
        for element in elements:
            ActionChains(driver).click(element).perform()

        time.sleep(10)

finally:
    # Закрытие браузера
    driver.quit()
